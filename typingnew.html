<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kids Typing Fun (Simple)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        /* Apply the game font */
        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #87CEEB; /* Sky blue background */
            display: flex;
            flex-direction: column; /* Stack elements vertically */
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden; /* Prevent scrollbars */
            color: #333;
            padding: 20px;
        }
        /* Style the game canvas */
        #gameCanvas {
            background-color: #ffffff; /* White canvas background */
            border: 5px solid #4CAF50; /* Green border */
            border-radius: 15px; /* Rounded corners for the canvas */
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); /* Add shadow */
            max-width: 100%; /* Ensure canvas fits smaller screens */
        }
        /* Style buttons */
        button {
            font-family: 'Press Start 2P', cursive;
            padding: 12px 24px; /* Slightly larger padding */
            margin: 15px; /* More margin */
            border-radius: 8px;
            border: 3px solid #333;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-transform: uppercase; /* Uppercase text */
        }
        /* Start button style */
        #startButton {
            background-color: #4CAF50; /* Green */
            color: white;
             border-color: #388E3C; /* Darker green border */
        }
        #startButton:hover {
            background-color: #66BB6A; /* Lighter green */
            transform: translateY(-2px); /* Slight lift on hover */
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
         #startButton:active {
             transform: translateY(0px);
             box-shadow: 0 3px 6px rgba(0,0,0,0.1);
         }
         #startButton:disabled {
              background-color: #cccccc;
              border-color: #aaaaaa;
              color: #888888;
              cursor: not-allowed;
              box-shadow: none;
              transform: none;
              filter: grayscale(50%);
         }
        /* Message box style */
        #messageBox {
            position: absolute;
            top: 40%; /* Position slightly higher */
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 25px 45px;
            border-radius: 10px;
            font-size: 1.5em; /* Larger text */
            text-align: center;
            z-index: 100; /* Ensure it's above the canvas */
            display: none; /* Hidden by default */
            border: 3px solid white;
        }
         /* Style for the score and lives */
        #stats {
            margin-top: 20px; /* More space */
            font-size: 1.3em; /* Larger stats */
            color: #2F4F4F; /* Dark Slate Gray */
            text-shadow: 1px 1px 1px #fff;
        }
    </style>
</head>
<body>

    <h1 class="text-4xl mb-4 text-yellow-400 text-center" style="text-shadow: 2px 2px #000;">Typing Fun!</h1>

    <canvas id="gameCanvas" width="600" height="400"></canvas>

    <div id="stats">
        Score: <span id="score">0</span> | Lives: <span id="lives">5</span>
    </div>

    <div class="mt-4">
        <button id="startButton">Start Game</button>
    </div>

    <div id="messageBox">Game Over!</div>

    <script>
        // Wrap entire script in DOMContentLoaded listener
        window.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Loaded, initializing script...");

            // Get canvas and context
            const canvas = document.getElementById('gameCanvas');
            // Check if canvas exists before getting context
            const ctx = canvas ? canvas.getContext('2d') : null;

            // Get UI elements
            const startButton = document.getElementById('startButton');
            const scoreDisplay = document.getElementById('score');
            const livesDisplay = document.getElementById('lives');
            const messageBox = document.getElementById('messageBox');

            // Check if essential elements were found
             if (!canvas || !ctx || !startButton || !scoreDisplay || !livesDisplay || !messageBox) {
                 console.error("One or more essential elements not found!");
                 // Optionally display an error to the user
                 document.body.innerHTML = '<h1 style="color:red; text-align: center;">Error: Could not load game elements.</h1>';
                 return; // Stop script execution
             }
             console.log("All essential elements found.");


            // --- Game Configuration ---
            const canvasWidth = canvas.width;
            const canvasHeight = canvas.height;
            const itemSize = 35; // Size of the falling shapes
            const initialFallSpeed = 1; // Starting speed
            const itemSpawnInterval = 1500; // Milliseconds between new items
            const lettersToUse = 'abcdefghijklmnopqrstuvwxyz'; // Letters that can fall
            const initialLives = 5;
            const colors = ['#FF6347', '#4682B4', '#32CD32', '#FFD700', '#6A5ACD', '#FF69B4']; // Tomato, SteelBlue, LimeGreen, Gold, SlateBlue, HotPink

            // --- Game State Variables ---
            let score = 0;
            let lives = initialLives;
            let fallingItems = []; // Array to hold active falling items
            let gameInterval = null; // For spawning items
            let animationFrameId = null; // For the game loop
            let currentSpeed;
            let isGameOver = false;
            let gameRunning = false;

            // --- Sound Effects ---
            let synth = null; // Initialize synth to null
            let correctSound = () => {}; // Default to no-op
            let missSound = () => {};
            let gameOverSound = () => {};

            // Function to initialize sounds (needs user interaction like button click)
            function initSounds() {
                if (!synth && typeof Tone !== 'undefined') { // Initialize only once and if Tone exists
                    try {
                        // Use a simple synth for sound effects
                        synth = new Tone.Synth().toDestination();
                        // Define sounds
                        correctSound = () => synth.triggerAttackRelease("C5", "8n", Tone.now()); // Higher pitch for correct
                        missSound = () => synth.triggerAttackRelease("C3", "8n", Tone.now());    // Lower pitch for miss/lose life
                        gameOverSound = () => synth.triggerAttackRelease("A2", "4n", Tone.now()); // Game over sound
                        console.log("Sounds initialized.");
                    } catch (e) {
                        console.error("Failed to initialize Tone.js synth:", e);
                        synth = null; // Ensure synth is null if failed
                        correctSound = missSound = gameOverSound = () => {}; // Fallback to no-op
                    }
                } else if (typeof Tone === 'undefined') {
                     console.warn("Tone.js library not loaded. Sounds disabled.");
                }
            }

            // --- Game Functions ---

            // Function to show messages
            function showMessage(text, duration = 2000) {
                if (!messageBox) return;
                messageBox.textContent = text;
                messageBox.style.display = 'block';
                if (duration > 0) {
                    setTimeout(() => {
                        messageBox.style.display = 'none';
                    }, duration);
                }
            }

            // Function to hide messages
            function hideMessage() {
                if (!messageBox) return;
                messageBox.style.display = 'none';
            }

            // Function to create a new falling item
            function createFallingItem() {
                const randomLetterIndex = Math.floor(Math.random() * lettersToUse.length);
                const letter = lettersToUse[randomLetterIndex];
                const x = Math.random() * (canvasWidth - itemSize); // Random horizontal position
                const y = -itemSize; // Start above the canvas
                const color = colors[Math.floor(Math.random() * colors.length)]; // Random color

                fallingItems.push({ x, y, letter, color });
            }

            // Function to draw a falling item (a colored circle with a letter)
            function drawItem(item) {
                if (!ctx) return;
                ctx.fillStyle = item.color;
                ctx.beginPath();
                ctx.arc(item.x + itemSize / 2, item.y + itemSize / 2, itemSize / 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.closePath();

                ctx.fillStyle = '#ffffff';
                ctx.font = `${itemSize * 0.6}px 'Press Start 2P'`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(item.letter.toUpperCase(), item.x + itemSize / 2, item.y + itemSize / 2 + 2);
            }

            // Function to update item positions
            function updateItems() {
                for (let i = fallingItems.length - 1; i >= 0; i--) {
                    const item = fallingItems[i];
                    item.y += currentSpeed;

                    if (item.y > canvasHeight) {
                        fallingItems.splice(i, 1);
                        lives--;
                        if(missSound) try { missSound(); } catch(e){}
                        updateStats();
                        if (lives <= 0) {
                            gameOver();
                            return;
                        }
                    }
                }
            }

            // Function to draw the game state
            function drawGame() {
                if (!ctx || !canvas) return;
                ctx.clearRect(0, 0, canvasWidth, canvasHeight);
                fallingItems.forEach(drawItem);
            }

            // Main Game Loop
            function gameLoop() {
                if (isGameOver || !gameRunning) return;

                updateItems();
                drawGame();
                currentSpeed += 0.0005;
                animationFrameId = requestAnimationFrame(gameLoop);
            }

            // Function to handle keyboard input
            function handleKeyPress(event) {
                if (!gameRunning || isGameOver) return;

                const keyPressed = event.key.toLowerCase();
                let correctKeyPress = false;

                for (let i = fallingItems.length - 1; i >= 0; i--) {
                    if (fallingItems[i].letter === keyPressed) {
                        fallingItems.splice(i, 1);
                        score++;
                        if(correctSound) try { correctSound(); } catch(e){}
                        updateStats();
                        correctKeyPress = true;
                        break;
                    }
                }
            }

            // Function to update score and lives display
            function updateStats() {
                if(scoreDisplay) scoreDisplay.textContent = score;
                if(livesDisplay) livesDisplay.textContent = lives;
            }

            // Function to end the game
            function gameOver() {
                isGameOver = true;
                gameRunning = false;
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                if (gameInterval) clearInterval(gameInterval);
                animationFrameId = null;
                gameInterval = null;

                if(gameOverSound) try { gameOverSound(); } catch(e){}
                showMessage('Game Over! Score: ' + score, 0);
                if(startButton) {
                    startButton.textContent = 'Play Again?';
                    startButton.disabled = false;
                }
            }

            // Function to reset and start the game
            function startGame() {
                initSounds();
                try { if (Tone.context.state !== 'running') Tone.start(); } catch(e) { console.error("Error starting Tone.js context:", e); }

                score = 0;
                lives = initialLives;
                fallingItems = [];
                currentSpeed = initialFallSpeed;
                isGameOver = false;
                gameRunning = true;
                hideMessage();
                updateStats();

                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                if (gameInterval) clearInterval(gameInterval);
                animationFrameId = null;
                gameInterval = null;

                if(startButton) {
                    startButton.textContent = 'Playing...';
                    startButton.disabled = true;
                }

                gameInterval = setInterval(createFallingItem, itemSpawnInterval);
                gameLoop(); // Start the loop
            }

            // --- Event Listeners ---
            // Already checked that startButton exists
            startButton.addEventListener('click', startGame);
            window.addEventListener('keydown', handleKeyPress);

            // Initial setup message
            showMessage("Press Start Game!", 3000);
            console.log("Initial setup complete. Event listeners attached.");

        }); // End DOMContentLoaded listener
    </script>

</body>
</html>
